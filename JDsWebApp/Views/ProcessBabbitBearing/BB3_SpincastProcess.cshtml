@using JDsDataModel.ViewModels
@model JDsDataModel.ViewModels.Processes.ProcessBabbittBearing.BB3_SpincastProcessViewModel

@{
    ViewBag.Title = "BB3_SpincastProcess";
}

<div class="row">
    <h4>Spincast Process</h4>
</div>

<form id="process_bb3_form">
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.Version)
    @Html.HiddenFor(m => m.JobId)
    @Html.HiddenFor(m => m.PartId)
    @Html.HiddenFor(m => m.ProcessId)
    @Html.HiddenFor(m => m.StepId)
    @Html.HiddenFor(m => m.IsUTRequired)
    @Html.HiddenFor(m => m.IsPTRequired)
    @Html.HiddenFor(m => m.IsDisplayUT)
    @Html.HiddenFor(m => m.IsDisplayPT)
    @Html.HiddenFor(m => m.IsCompleted, new { id = "IsCompleted" })
    @Html.HiddenFor(m => m.BaseMaterial)
    @Html.HiddenFor(m => m.IsOnlySave, new { id = "IsOnlySave" })

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            @Html.SignOffHelper(m => m.DeburredBy, "BB3_DeburredBy")
        </div>
    </div>
    @if (Model.BaseMaterial == "Cast Iron")
    {
        <div class="row padd-top padd-bottom">
            <div class="col-sm-5">
                @Html.SignOffHelper(m => m.TinnedBy, "BB3_TinnedBy")
            </div>
        </div>
    }
    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            @Html.SignOffHelper(m => m.PlasteredBy, "BB3_PlasteredBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            <div class="row">
                <div class="col-sm-12">
                    @Html.LabelFor(m => m.RPM)
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    @Html.TextBoxFor(m => m.RPM, new { @id = "BB3_RPM", @class="form-control", @type="number" })
                </div>
            </div>
        </div>
        <div class="col-sm-offset-1 col-sm-5">
            @Html.SignOffHelper(m => m.RPMBy, "BB3_RPMBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            <div class="row">
                <div class="col-sm-12">
                    @Html.LabelFor(m => m.BabbitTemp)
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    @Html.TextBoxFor(m => m.BabbitTemp, new { @id = "BB3_BabbitTemp", @class = "form-control", @type = "number" })
                </div>
            </div>
        </div>
        <div class="col-sm-offset-1 col-sm-5">
            @Html.SignOffHelper(m => m.BabbitTempBy, "BB3_BabbitTempBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            <div class="row">
                <div class="col-sm-12">
                    @Html.LabelFor(m => m.PlateTemp)
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    @Html.TextBoxFor(m => m.PlateTemp, new { @id = "BB3_PlateTemp", @class = "form-control", @type = "number" })
                </div>
            </div>
        </div>
        <div class="col-sm-offset-1 col-sm-5">
            @Html.SignOffHelper(m => m.PlateTempBy, "BB3_PlateTempBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            @Html.SignOffHelper(m => m.ScrubbedBy, "BB3_ScrubbedBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            @Html.SignOffHelper(m => m.SpuncastBy, "BB3_SpuncastBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-5">
            @Html.SignOffHelper(m => m.CutApartBy, "BB3_CutApartBy")
        </div>
    </div>

    <div class="row padd-top padd-bottom">
        <div class="col-sm-2">
            <a class="btn btn-block btn-primary" id="saveBtn">Save</a>
        </div>
        <div class="col-sm-2">
            <a class="btn btn-block btn-danger" id="cancelBtn">Cancel</a>
        </div>
    </div>
    <div class="extraSpaceAtBtmDiv"></div>
</form>

<div class="modal fade" id="signOffGroupModal" role="dialog">
    <div class="modal-dialog">
        <h4 class="modal-header"> Sign Off Error</h4>
        <div class="modal-body" style="margin-left: 40px">
            <div class="jd-table">
                <div class="jd-table-row">
                    <h4>The following sign offs have not been completed.</h4>
                </div>
            </div>
            <div class="jd-table">
                <div class="row padd-top padd-bottom" id="BB3_DeburredByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.DeburredBy, "BB3_DeburredBy1")
                    </div>
                </div>
                @if (Model.BaseMaterial == "Cast Iron")
                {
                    <div class="row padd-bottom" id="BB3_TinnedByGroup">
                        <div class="col-sm-7">
                            @Html.SignOffHelper(m => m.TinnedBy, "BB3_TinnedBy1")
                        </div>
                    </div>
                }
                <div class="row padd-bottom" id="BB3_PlasteredByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.PlasteredBy, "BB3_PlasteredBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_RPMByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.RPMBy, "BB3_RPMBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_BabbitTempByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.BabbitTempBy, "BB3_BabbitTempBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_PlateTempByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.PlateTempBy, "BB3_PlateTempBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_ScrubbedByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.ScrubbedBy, "BB3_ScrubbedBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_SpuncastByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.SpuncastBy, "BB3_SpuncastBy1")
                    </div>
                </div>

                <div class="row padd-bottom" id="BB3_CutApartByGroup">
                    <div class="col-sm-7">
                        @Html.SignOffHelper(m => m.CutApartBy, "BB3_CutApartBy1")
                    </div>
                </div>

                <div class="row padd-top">
                    <div class="col-sm-offset-7 col-sm-3">
                        <a id="signoffallbtn" class="btn btn-primary signOffBtn" onclick="OnClickSignOffAll()"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span> SignOff All</a>
                    </div>
                    <div class="col-sm-2">
                        <a id="cancelsignoffallbtn" class="btn btn-danger" onclick="OnClickCancelSignOffAll()">Cancel</a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>


        $(function ()
        {
            var signOffAllRequested = false;

            $("#signOffModal").on('hidden.bs.modal', function () {
                if( signOffAllRequested == true
                    && $("#BB3_DeburredBy1").val()
                    && ('@Model.BaseMaterial' != "Cast Iron" || $("#BB3_TinnedBy1").val())
                    && $("#BB3_PlasteredBy1").val()
                    && $("#BB3_RPMBy1").val()
                    && $("#BB3_BabbitTempBy1").val()
                    && $("#BB3_PlateTempBy1").val()
                    && $("#BB3_ScrubbedBy1").val()
                    && $("#BB3_SpuncastBy1").val()
                    && $("#BB3_CutApartBy1").val())
                {
                    // All sign offs have been signed
                   Save();
                }
                signOffAllRequested = false;
            });
            $("#signoffallbtn").click(function () {
                signOffAllRequested = true;
            });

            setCurrentStep(stepData,'process_BB3_SpincastProcessEntry');
            $('#process_BB3_SpincastProcessEntry').css('font-size', 12);

            $("#saveBtn").click(function () {
                Save();
            });

            $("#cancelBtn").click(function () {
                Cancel();
            });
        });

        function IsStepValid() {
            var isvalid = 1;

            // Perform signoff validation and dialog...
            if ($('#BB3_DeburredBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_DeburredByGroup").show();
                $('#BB3_DeburredBy1SO').addClass("btn-danger");
                $('#BB3_DeburredBySO').addClass("btn-danger");
            } else {
                $("#BB3_DeburredByGroup").hide();
                $('#BB3_DeburredBy1SO').removeClass("btn-danger");
                $('#BB3_DeburredBySO').removeClass("btn-danger");
            }

            if ('@Model.BaseMaterial' == "Cast Iron" && $('#BB3_TinnedBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_TinnedByGroup").show();
                $('#BB3_TinnedBy1SO').addClass("btn-danger");
                $('#BB3_TinnedBySO').addClass("btn-danger");
            } else {
                $("#BB3_TinnedByGroup").hide();
                $('#BB3_TinnedBy1SO').removeClass("btn-danger");
                $('#BB3_TinnedBySO').removeClass("btn-danger");
            }

            if ($('#BB3_PlasteredBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_PlasteredByGroup").show();
                $('#BB3_PlasteredBy1SO').addClass("btn-danger");
                $('#BB3_PlasteredBySO').addClass("btn-danger");
            } else {
                $("#BB3_PlasteredByGroup").hide();
                $('#BB3_PlasteredBy1SO').removeClass("btn-danger");
                $('#BB3_PlasteredBySO').removeClass("btn-danger");
            }

            if ($('#BB3_RPMBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_RPMByGroup").show();
                $('#BB3_RPMBy1SO').addClass("btn-danger");
                $('#BB3_RPMBySO').addClass("btn-danger");
            } else {
                $("#BB3_RPMByGroup").hide();
                $('#BB3_RPMBy1SO').removeClass("btn-danger");
                $('#BB3_RPMBySO').removeClass("btn-danger");
            }

            if ($('#BB3_BabbitTempBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_BabbitTempByGroup").show();
                $('#BB3_BabbitTempBy1SO').addClass("btn-danger");
                $('#BB3_BabbitTempBySO').addClass("btn-danger");
            } else {
                $("#BB3_BabbitTempByGroup").hide();
                $('#BB3_BabbitTempBy1SO').removeClass("btn-danger");
                $('#BB3_BabbitTempBySO').removeClass("btn-danger");
            }

            if ($('#BB3_PlateTempBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_PlateTempByGroup").show();
                $('#BB3_PlateTempBy1SO').addClass("btn-danger");
                $('#BB3_PlateTempBySO').addClass("btn-danger");
            } else {
                $("#BB3_PlateTempByGroup").hide();
                $('#BB3_PlateTempBy1SO').removeClass("btn-danger");
                $('#BB3_PlateTempBySO').removeClass("btn-danger");
            }

            if ($('#BB3_ScrubbedBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_ScrubbedByGroup").show();
                $('#BB3_ScrubbedBy1SO').addClass("btn-danger");
                $('#BB3_ScrubbedBySO').addClass("btn-danger");
            } else {
                $("#BB3_ScrubbedByGroup").hide();
                $('#BB3_ScrubbedBy1SO').removeClass("btn-danger");
                $('#BB3_ScrubbedBySO').removeClass("btn-danger");
            }

            if ($('#BB3_SpuncastBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_SpuncastByGroup").show();
                $('#BB3_SpuncastBy1SO').addClass("btn-danger");
                $('#BB3_SpuncastBySO').addClass("btn-danger");
            } else {
                $("#BB3_SpuncastByGroup").hide();
                $('#BB3_SpuncastBy1SO').removeClass("btn-danger");
                $('#BB3_SpuncastBySO').removeClass("btn-danger");
            }

            if ($('#BB3_CutApartBy').val().trim() == "") {
                isvalid = 0;
                $("#BB3_CutApartByGroup").show();
                $('#BB3_CutApartBy1SO').addClass("btn-danger");
                $('#BB3_CutApartBySO').addClass("btn-danger");
            } else {
                $("#BB3_CutApartByGroup").hide();
                $('#BB3_CutApartBy1SO').removeClass("btn-danger");
                $('#BB3_CutApartBySO').removeClass("btn-danger");
            }

            if (isvalid == 0) {
                $('#signOffGroupModal').modal('show');
                return false;
            }

            return true;
        }

        function Save() {
            if(!IsStepValid()) {
                return false;
            }

            // Apply grid data to model
            markStepAsCompleted();
            SaveToServer();

            return true;
        }

        function SaveToServer(isOnlySave) {
            isOnlySave = isOnlySave || false;

            if (isOnlySave) {
                $("#IsOnlySave").val(true);
            }

            $.ajax({
                url: '/ProcessBabbitBearing/Save_BB3_SpincastProcess',
                type: 'POST',
                data: $("#process_bb3_form").serialize(),
                success: function (data) {
                    notification.show({message: "SAVED SUCCESSFULLY"}, "successful");
                    if (!isOnlySave) {
                        window.location.href = "/ProcessBabbitBearing/BB4_PostcastCleanup?id=" + '@Html.Raw(Json.Encode(Model.ProcessId))';
                    }
                },
                error: function (response, error) {
                    bootbox.alert(error, function () {});
                }
            });
        }

        function Cancel() {
            window.location.href = "/ProcessBabbitBearing/BB3_SpincastProcess?id=" + '@Html.Raw(Json.Encode(Model.ProcessId))';
        }

        function OnClickSignOff(data) {
            navId = 0;
            signOffId = data;

            var skillname = "";

            switch (data) {
                case 'BB3_DeburredBy':
                case 'BB3_DeburredBy1':
                    skillname = "Tinning";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Deburred By");
                    break;
                case 'BB3_TinnedBy':
                case 'BB3_TinnedBy1':
                    skillname = "Tinning";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Tinned By");
                    break;
                case 'BB3_PlasteredBy':
                case 'BB3_PlasteredBy1':
                    skillname = "Tinning";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Plastered By");
                    break;
                case 'BB3_RPMBy':
                case 'BB3_RPMBy1':
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: RPM By");
                    skillname = "Centrifugal Cast";
                    break;
                case 'BB3_BabbitTempBy':
                case 'BB3_BabbitTempBy1':
                    skillname = "Tinning";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Babbitt Temp by");
                    break;
                case 'BB3_PlateTempBy':
                case 'BB3_PlateTempBy1':
                    skillname = "Tinning";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Plate Temp By");
                    break;
                case 'BB3_ScrubbedBy':
                case 'BB3_ScrubbedBy1':
                    skillname = "Centrifugal Cast";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Scrubbed By");
                    break;
                case 'BB3_SpuncastBy':
                case 'BB3_SpuncastBy1':
                    skillname = "Centrifugal Cast";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Spuncast By");
                    break;
                case 'BB3_CutApartBy':
                case 'BB3_CutApartBy1':
                    skillname = "Centrifugal Cast";
                    addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Cut Apart By");
                    break;
            }

            $.ajax({
                url: '@Url.Action("SignOff", "SignOff", new { area = "" })',
                type: 'GET',
                data: { skillName: skillname },
                success: function (data) {
                    $('#signOffContentDiv').html(data);
                    $('#signOffContentDiv').fadeIn('fast');
                    $('#signOffModal').modal('show');
                },
                error: function (e) {
                    bootbox.alert("Not Authorized", function () {});
                    $("#signOffModal").modal('hide');
                }
            });
        }

        function OnClickSignOffAll() {
            navId = 0;
            var ids = "";
            var count = 0;
            addJobChangeLogEntry(@Model.JobId, "Attempting signoff for: Spincast Process");

            if ($('#BB3_DeburredBy').val().trim() == "") {
                ids = ids + "BB3_DeburredBy";
                count = count + 1;
            }

            if('@Model.BaseMaterial' == "Cast Iron")
            {
                if ($('#BB3_TinnedBy').val().trim() == "") {
                    if (count > 0) {
                        ids = ids + ",";
                    }

                    ids = ids + "BB3_TinnedBy";
                    count = count + 1;
                }
            }

            if ($('#BB3_PlasteredBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_PlasteredBy";
                count = count + 1;
            }

            if ($('#BB3_RPMBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_RPMBy";
                count = count + 1;
            }

            if ($('#BB3_BabbitTempBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_BabbitTempBy";
                count = count + 1;
            }

            if ($('#BB3_PlateTempBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_PlateTempBy";
                count = count + 1;
            }

            if ($('#BB3_ScrubbedBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_ScrubbedBy";
                count = count + 1;
            }

            if ($('#BB3_SpuncastBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_SpuncastBy";
                count = count + 1;
            }

            if ($('#BB3_CutApartBy').val().trim() == "") {
                if (count > 0) {
                    ids = ids + ",";
                }

                ids = ids + "BB3_CutApartBy";
                count = count + 1;
            }

            signOffId = ids;
            var skillname = "Centrifugal Cast";

            $.ajax({
                url: '@Url.Action("SignOff", "SignOff", new {area = ""})',
                type: 'GET',
                data: { skillName: skillname },
                success: function (data) {
                    $('#signOffContentDiv').html(data);
                    $('#signOffContentDiv').fadeIn('fast');
                    $('#signOffModal').modal('show');
                    $('#signOffGroupModal').modal('hide');
                },
                error: function (e) {
                    bootbox.alert("Not Authorized", function () {});
                    $("#signOffModal").modal('hide');
                }
            });
        }

        function OnClickCancelSignOffAll()
        {
            // capture any completed signoffs--definition on site.js
            captureCompletedSignoffs();

            $('#signOffGroupModal').modal('hide');
        }

    </script>
}
